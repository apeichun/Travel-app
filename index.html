<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Kansai Trip 2025 (Smooth Sort)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- [NEW] SortableJS: 最強大的拖拉排序函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- React & ReactDOM -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        onSnapshot,
        setDoc,
        collection,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      window.Firebase = {
        initializeApp,
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
        getFirestore,
        doc,
        onSnapshot,
        setDoc,
        collection,
      };
    </script>

    <style>
      body {
        -webkit-tap-highlight-color: transparent;
        background-color: #f9fafb;
        user-select: none;
      }
      .pb-safe {
        padding-bottom: calc(4rem + env(safe-area-inset-bottom));
      }
      input:focus,
      textarea:focus,
      select:focus {
        outline: 2px solid #bae6fd;
        border-color: #38bdf8;
      }
      .safe-bottom {
        padding-bottom: env(safe-area-inset-bottom);
      }

      /* SortableJS 樣式 */
      .sortable-ghost {
        opacity: 0.4;
        background: #e0f2fe;
        border: 2px dashed #38bdf8;
      } /* 拖曳時原位置的樣式 */
      .sortable-drag {
        opacity: 1;
        background: white;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        transform: scale(1.02);
      } /* 正在被拖曳項目的樣式 */

      .drag-handle {
        touch-action: none;
        cursor: grab;
      }
      .drag-handle:active {
        cursor: grabbing;
      }

      @media (min-width: 768px) {
        ::-webkit-scrollbar {
          width: 8px;
          height: 8px;
        }
        ::-webkit-scrollbar-track {
          background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
          background: #cbd5e1;
          border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
          background: #94a3b8;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef, useCallback, memo } = React;

      // =================================================================================
      // [重要] 請在此處填入您的 Firebase 設定
      // =================================================================================
      const YOUR_FIREBASE_CONFIG = {
        apiKey: "AIzaSyCH2awCY1eWCKO03nCc3ixJiOGtoz1u5tg",
        authDomain: "travel-app-4560d.firebaseapp.com",
        projectId: "travel-app-4560d",
        storageBucket: "travel-app-4560d.firebasestorage.app",
        messagingSenderId: "813547420756",
        appId: "1:813547420756:web:f6f21c91b28556627741c1",
      };

      const APP_ID = "my-kansai-trip-2025";
      // =================================================================================

      const TIME_OPTIONS = (() => {
        const options = ["待定"];
        for (let h = 0; h < 24; h++) {
          for (let m = 0; m < 60; m += 15) {
            options.push(
              `${h.toString().padStart(2, "0")}:${m
                .toString()
                .padStart(2, "0")}`
            );
          }
        }
        return options;
      })();

      const DEFAULT_ITINERARY = [
        {
          id: 1,
          date: "2/6 (五)",
          title: "Day 1: 抵達大阪",
          events: [
            {
              id: "e1",
              time: "10:55",
              location: "關西機場 (KIX)",
              transport: "入境",
              note: "抵達後前往二樓，順空橋走至南海電鐵",
            },
            {
              id: "e2",
              time: "12:00",
              location: "南海電鐵",
              transport: "Rapit 特急",
              note: "搭乘 Rapit 到天下茶屋或難波轉乘",
            },
          ],
        },
        {
          id: 2,
          date: "2/7 (六)",
          title: "Day 2: 大阪城 & 歷史",
          events: [
            {
              id: "e8",
              time: "08:30",
              location: "木津市場",
              transport: "地鐵",
              note: "新鮮海鮮早餐",
            },
          ],
        },
      ];
      const DEFAULT_MUSTBUY = [
        { area: "梅田", items: ["Baton d'or", "Grand Calbee"] },
        { area: "京都", items: ["茶之菓", "京年輪蛋糕"] },
      ];

      const DAY_COLORS = [
        {
          header: "bg-blue-100 text-blue-900",
          body: "bg-blue-50/50",
          border: "border-blue-100",
          accent: "text-blue-600",
          sub: "bg-blue-50 text-blue-700",
        },
        {
          header: "bg-emerald-100 text-emerald-900",
          body: "bg-emerald-50/50",
          border: "border-emerald-100",
          accent: "text-emerald-600",
          sub: "bg-emerald-50 text-emerald-700",
        },
        {
          header: "bg-violet-100 text-violet-900",
          body: "bg-violet-50/50",
          border: "border-violet-100",
          accent: "text-violet-600",
          sub: "bg-violet-50 text-violet-700",
        },
        {
          header: "bg-orange-100 text-orange-900",
          body: "bg-orange-50/50",
          border: "border-orange-100",
          accent: "text-orange-600",
          sub: "bg-orange-50 text-orange-700",
        },
        {
          header: "bg-rose-100 text-rose-900",
          body: "bg-rose-50/50",
          border: "border-rose-100",
          accent: "text-rose-600",
          sub: "bg-rose-50 text-rose-700",
        },
      ];

      const Icon = ({ path, size = 20, className = "", onClick }) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width={size}
          height={size}
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          className={className}
          onClick={onClick}
          style={{ cursor: onClick ? "pointer" : "default" }}
        >
          <path d={path} />
        </svg>
      );
      const ICONS = {
        calendar:
          "M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 0V2m-14 0v2m0 10h16",
        mapPin:
          "M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z M12 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6",
        shoppingBag:
          "M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z M3 6h18 M16 10a4 4 0 0 1-8 0",
        receipt:
          "M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1Z M16 8H8 M16 12H8 M13 16H8",
        edit: "M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z",
        save: "M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z M17 21v-8H7v8 M7 3v5h8",
        trash:
          "M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
        plus: "M12 5v14M5 12h14",
        check: "M20 6L9 17l-5-5",
        train:
          "M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H12c-.7 0-1.3.3-1.8.7-.9.9-2.2 2.3-2.2 2.3s-2.7.6-4.5 1.1C2.7 11.3 2 12.1 2 13v3c0 .6.4 1 1 1h2 M7 19h10 M9 10h6 M12 5v5",
        externalLink:
          "M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6 M15 3h6v6 M10 14L21 3",
        globe:
          "M2 12h20 M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z",
        refresh: "M23 4v6h-6 M1 20v-6h6",
        wifi: "M5 12.55a11 11 0 0 1 14.08 0 M1.42 9a16 16 0 0 1 21.16 0 M8.53 16.11a6 6 0 0 1 6.95 0 M12 20h.01",
        wifiOff:
          "M1 1l22 22 M16.72 11.06A10.94 10.94 0 0 1 19 12.55 M5 12.55a10.94 10.94 0 0 1 5.17-2.39 M10.71 5.05A16 16 0 0 1 22.58 9 M1.42 9a15.91 15.91 0 0 1 4.7-2.88 M8.53 16.11a6 6 0 0 1 6.95 0 M12 20h.01",
        grip: "M3 12h18 M3 6h18 M3 18h18",
        sort: "M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01",
      };

      const LinkifiedText = ({ text }) => {
        if (!text) return null;
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const parts = text.split(urlRegex);
        return (
          <>
            {parts.map((part, index) =>
              part.match(urlRegex) ? (
                <a
                  key={index}
                  href={part}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-sky-500 hover:text-sky-600 hover:underline break-all relative z-10"
                  onClick={(e) => e.stopPropagation()}
                >
                  {part}
                </a>
              ) : (
                part
              )
            )}
          </>
        );
      };

      const App = () => {
        const [activeTab, setActiveTab] = useState("itinerary");
        const [authLoading, setAuthLoading] = useState(true);
        const [user, setUser] = useState(null);
        const [configError, setConfigError] = useState(false);
        const [data, setData] = useState({
          itinerary: [],
          shopping: [],
          mustBuy: [],
          expenses: [],
        });

        // UI States
        const [editingEventId, setEditingEventId] = useState(null);
        const [reorderingDayId, setReorderingDayId] = useState(null); // Which day is in Sort Mode

        const [newItem, setNewItem] = useState({ name: "", qty: 1, note: "" });
        const [expenseForm, setExpenseForm] = useState({
          item: "",
          total: "",
          people: "2",
          payer: "公費",
        });
        const [mustBuyForm, setMustBuyForm] = useState({ area: "", item: "" });

        const [db, setDb] = useState(null);

        // --- Firebase Init ---
        useEffect(() => {
          const initFirebase = async () => {
            if (!window.Firebase) return;
            if (YOUR_FIREBASE_CONFIG.apiKey.includes("請在此處貼上")) {
              setConfigError(true);
              setAuthLoading(false);
              return;
            }
            try {
              const app = window.Firebase.initializeApp(YOUR_FIREBASE_CONFIG);
              const auth = window.Firebase.getAuth(app);
              const firestore = window.Firebase.getFirestore(app);
              setDb(firestore);
              await window.Firebase.signInAnonymously(auth);
              window.Firebase.onAuthStateChanged(auth, (u) => {
                setUser(u);
                setAuthLoading(false);
              });
            } catch (error) {
              console.error("Firebase Init Error:", error);
              alert("Firebase 初始化失敗");
              setAuthLoading(false);
            }
          };
          initFirebase();
        }, []);

        // --- Realtime Listeners ---
        useEffect(() => {
          if (!user || !db) return;
          const setupListener = (docName, dataKey, defaultVal) => {
            const docRef = window.Firebase.doc(
              window.Firebase.collection(
                db,
                "artifacts",
                APP_ID,
                "public",
                "data",
                "trip_data"
              ),
              docName
            );
            return window.Firebase.onSnapshot(docRef, (docSnap) => {
              if (docSnap.exists())
                setData((prev) => ({
                  ...prev,
                  [dataKey]: docSnap.data().list || [],
                }));
              else if (defaultVal)
                setData((prev) => ({ ...prev, [dataKey]: defaultVal }));
            });
          };
          const unsubs = [
            setupListener("itinerary", "itinerary", DEFAULT_ITINERARY),
            setupListener("shopping", "shopping", []),
            setupListener("mustBuy", "mustBuy", DEFAULT_MUSTBUY),
            setupListener("expenses", "expenses", []),
          ];
          return () => unsubs.forEach((u) => u());
        }, [user, db]);

        const saveToFirebase = async (key, newList) => {
          if (!user || !db) return;
          try {
            await window.Firebase.setDoc(
              window.Firebase.doc(
                window.Firebase.collection(
                  db,
                  "artifacts",
                  APP_ID,
                  "public",
                  "data",
                  "trip_data"
                ),
                key
              ),
              { list: newList }
            );
          } catch (e) {
            console.error("Save failed:", e);
          }
        };

        // --- Day Card with SortableJS ---
        const DayCard = ({
          day,
          color,
          isReordering,
          toggleReorder,
          onUpdateEvents,
          onDeleteEvent,
          onEditEvent,
          editingEventId,
          onSaveEvent,
          updateItineraryLocal,
        }) => {
          const listRef = useRef(null);
          const sortableInstance = useRef(null);

          useEffect(() => {
            if (isReordering && listRef.current) {
              sortableInstance.current = new Sortable(listRef.current, {
                handle: ".drag-handle", // Handle class
                animation: 150, // Smooth animation
                ghostClass: "sortable-ghost",
                dragClass: "sortable-drag",
                delay: 0, // Instant drag on touch
                onEnd: (evt) => {
                  const newEvents = [...day.events];
                  const [movedItem] = newEvents.splice(evt.oldIndex, 1);
                  newEvents.splice(evt.newIndex, 0, movedItem);
                  onUpdateEvents(day.id, newEvents);
                },
              });
            } else {
              if (sortableInstance.current) {
                sortableInstance.current.destroy();
                sortableInstance.current = null;
              }
            }
            return () => {
              if (sortableInstance.current) sortableInstance.current.destroy();
            };
          }, [isReordering, day.events, onUpdateEvents, day.id]);

          return (
            <div
              className={`bg-white rounded-2xl shadow-sm border ${
                color.border
              } overflow-hidden flex flex-col transition-all duration-300 ${
                isReordering ? "ring-2 ring-orange-400" : ""
              }`}
            >
              <div
                className={`${color.header} p-4 border-b ${color.border} flex items-center justify-between gap-3`}
              >
                <div className="flex items-center gap-3 overflow-hidden">
                  <span
                    className={`${color.sub} text-xs font-bold px-2.5 py-1 rounded-lg shadow-sm flex-shrink-0`}
                  >
                    {day.date}
                  </span>
                  <h3 className="font-bold text-base truncate">
                    {day.title.replace(/^Day \d+: /, "")}
                  </h3>
                </div>
                <button
                  onClick={toggleReorder}
                  className={`p-2 rounded-full text-xs font-bold flex items-center justify-center transition-all active:scale-95 flex-shrink-0 ${
                    isReordering
                      ? "bg-orange-500 text-white shadow-md"
                      : "bg-white/50 hover:bg-white text-gray-500 hover:text-sky-600"
                  }`}
                  title={isReordering ? "完成排序" : "排序行程"}
                >
                  <Icon
                    path={isReordering ? ICONS.check : ICONS.sort}
                    size={18}
                  />
                </button>
              </div>

              <div
                ref={listRef}
                className={`divide-y ${color.border} ${color.body} flex-1 ${
                  isReordering ? "bg-orange-50/30" : ""
                }`}
              >
                {day.events.map((e) => {
                  const isEditing = editingEventId === e.id;
                  return (
                    <div
                      key={e.id}
                      className={`event-item p-4 flex gap-3 relative group transition-all duration-200 ${
                        isEditing
                          ? "bg-white shadow-lg z-10 scale-[1.02] border-y border-sky-200 my-2 rounded-lg"
                          : "bg-white/60 hover:bg-white/90"
                      }`}
                    >
                      {isReordering && (
                        <div className="drag-handle w-10 -ml-2 flex items-center justify-center text-orange-400 hover:text-orange-600 cursor-grab active:cursor-grabbing border-r border-orange-100/50 mr-2">
                          <Icon path={ICONS.grip} size={24} />
                        </div>
                      )}

                      <div className="w-16 flex-shrink-0 flex flex-col items-center pt-1">
                        {isEditing ? (
                          <select
                            value={e.time}
                            onChange={(ev) =>
                              updateItineraryLocal(
                                day.id,
                                e.id,
                                "time",
                                ev.target.value
                              )
                            }
                            className="w-full text-xs border border-gray-300 rounded p-1.5 text-center bg-white focus:ring-2 focus:ring-sky-500 shadow-sm"
                            style={{ textAlignLast: "center" }}
                          >
                            {!TIME_OPTIONS.includes(e.time) && (
                              <option value={e.time}>{e.time}</option>
                            )}
                            {TIME_OPTIONS.map((t) => (
                              <option key={t} value={t}>
                                {t}
                              </option>
                            ))}
                          </select>
                        ) : (
                          <span
                            className={`text-sm font-bold ${
                              color.accent
                            } font-mono bg-white/80 px-1.5 rounded shadow-sm ${
                              isReordering ? "opacity-50" : ""
                            }`}
                          >
                            {e.time}
                          </span>
                        )}
                        {!isEditing && !isReordering && (
                          <div
                            className={`h-full w-0.5 ${color.border.replace(
                              "border",
                              "bg"
                            )} mt-2 mb-[-20px] rounded-full`}
                          ></div>
                        )}
                      </div>

                      <div className="flex-1 pb-1 space-y-1.5 min-w-0">
                        {isEditing ? (
                          <div className="space-y-3">
                            <input
                              value={e.location}
                              onChange={(ev) =>
                                updateItineraryLocal(
                                  day.id,
                                  e.id,
                                  "location",
                                  ev.target.value
                                )
                              }
                              className="w-full border border-gray-300 p-2 rounded-lg font-bold text-gray-800 text-sm focus:ring-2 focus:ring-sky-500"
                              placeholder="地點"
                            />
                            <div className="flex gap-2">
                              <input
                                value={e.transport}
                                onChange={(ev) =>
                                  updateItineraryLocal(
                                    day.id,
                                    e.id,
                                    "transport",
                                    ev.target.value
                                  )
                                }
                                className="w-1/3 border border-gray-300 p-2 rounded-lg text-xs"
                                placeholder="交通"
                              />
                              <textarea
                                value={e.note}
                                onChange={(ev) =>
                                  updateItineraryLocal(
                                    day.id,
                                    e.id,
                                    "note",
                                    ev.target.value
                                  )
                                }
                                className="flex-1 border border-gray-300 p-2 rounded-lg text-xs"
                                rows="2"
                                placeholder="備註"
                              ></textarea>
                            </div>
                          </div>
                        ) : (
                          <div
                            className={
                              isReordering
                                ? "opacity-70 pointer-events-none"
                                : ""
                            }
                          >
                            <div className="flex justify-between items-start">
                              <h4 className="font-bold text-gray-800 text-base">
                                {e.location}
                              </h4>
                            </div>
                            {e.transport && (
                              <div
                                className={`inline-flex items-center gap-1.5 text-[11px] ${color.accent} bg-white/80 px-2 py-1 rounded-md font-medium border ${color.border}`}
                              >
                                <Icon path={ICONS.train} size={12} />{" "}
                                {e.transport}
                              </div>
                            )}
                            {e.note && (
                              <p className="text-sm text-gray-500 whitespace-pre-line leading-relaxed bg-white/50 p-2 rounded-lg border border-transparent">
                                <LinkifiedText text={e.note} />
                              </p>
                            )}
                          </div>
                        )}
                      </div>

                      {!isReordering && (
                        <div className="flex flex-col items-center justify-start gap-2 pl-2 border-l border-gray-100/50">
                          {isEditing ? (
                            <>
                              <button
                                onClick={onSaveEvent}
                                className="p-2 bg-green-500 text-white rounded-full shadow-lg hover:bg-green-600 active:scale-90 transition-all"
                                title="儲存"
                              >
                                <Icon path={ICONS.check} size={16} />
                              </button>
                              <button
                                onClick={() => onDeleteEvent(day.id, e.id)}
                                className="p-2 bg-red-50 text-red-500 rounded-full hover:bg-red-100 active:scale-90 transition-all"
                                title="刪除"
                              >
                                <Icon path={ICONS.trash} size={16} />
                              </button>
                            </>
                          ) : (
                            <button
                              onClick={() => onEditEvent(e.id)}
                              className="p-2 text-gray-400 hover:text-sky-500 hover:bg-sky-50 rounded-full transition-all"
                              title="編輯內容"
                            >
                              <Icon path={ICONS.edit} size={18} />
                            </button>
                          )}
                          {!isEditing && (
                            <a
                              href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
                                e.location
                              )}`}
                              target="_blank"
                              className="p-2 text-gray-300 hover:text-green-500 hover:bg-green-50 rounded-full transition-all"
                            >
                              <Icon path={ICONS.mapPin} size={18} />
                            </a>
                          )}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
              {!isReordering && (
                <button
                  onClick={
                    window.addItineraryEventLocal
                      ? () => window.addItineraryEventLocal(day.id)
                      : null
                  }
                  className={`w-full py-3 ${color.accent} text-sm font-bold flex justify-center items-center gap-2 hover:bg-white/50 border-t border-dashed ${color.border} transition-colors`}
                >
                  <Icon path={ICONS.plus} size={18} /> 新增事件
                </button>
              )}
            </div>
          );
        };

        // --- Event Handlers ---
        const onUpdateEvents = useCallback(
          (dayId, newEvents) => {
            // Callback for SortableJS
            const newData = data.itinerary.map((d) =>
              d.id === dayId ? { ...d, events: newEvents } : d
            );
            setData((prev) => ({ ...prev, itinerary: newData }));
            saveToFirebase("itinerary", newData);
          },
          [data.itinerary]
        );

        const updateItineraryLocal = (dId, eId, k, v) => {
          const newList = data.itinerary.map((d) =>
            d.id !== dId
              ? d
              : {
                  ...d,
                  events: d.events.map((e) =>
                    e.id === eId ? { ...e, [k]: v } : e
                  ),
                }
          );
          setData((p) => ({ ...p, itinerary: newList }));
        };

        const saveSingleEvent = () => {
          saveToFirebase("itinerary", data.itinerary);
          setEditingEventId(null);
        };

        // Exposed to global for button click binding (quick hack for prop drilling)
        window.addItineraryEventLocal = (dId) => {
          const newId = `new_${Date.now()}`;
          const newList = data.itinerary.map((d) =>
            d.id === dId
              ? {
                  ...d,
                  events: [
                    ...d.events,
                    {
                      id: newId,
                      time: "待定",
                      location: "新地點",
                      transport: "",
                      note: "",
                    },
                  ],
                }
              : d
          );
          setData((p) => ({ ...p, itinerary: newList }));
          saveToFirebase("itinerary", newList);
          setEditingEventId(newId);
        };

        const deleteItineraryEventLocal = (dId, eId) => {
          if (confirm("刪除此活動？")) {
            const newList = data.itinerary.map((d) =>
              d.id === dId
                ? { ...d, events: d.events.filter((e) => e.id !== eId) }
                : d
            );
            setData((p) => ({ ...p, itinerary: newList }));
            saveToFirebase("itinerary", newList);
            setEditingEventId(null);
          }
        };

        // Other tabs logic
        const addShop = () => {
          if (!newItem.name) return;
          const newList = [
            ...data.shopping,
            { ...newItem, id: Date.now(), checked: false },
          ];
          saveToFirebase("shopping", newList);
          setNewItem({ name: "", qty: 1, note: "" });
        };
        const toggleShop = (id) => {
          const newList = data.shopping.map((i) =>
            i.id === id ? { ...i, checked: !i.checked } : i
          );
          saveToFirebase("shopping", newList);
        };
        const delShop = (id) => {
          if (confirm("刪除？")) {
            const newList = data.shopping.filter((i) => i.id !== id);
            saveToFirebase("shopping", newList);
          }
        };
        const addMustBuy = () => {
          if (!mustBuyForm.area || !mustBuyForm.item) return;
          const newList = [...data.mustBuy];
          const idx = newList.findIndex((a) => a.area === mustBuyForm.area);
          if (idx >= 0) newList[idx].items.push(mustBuyForm.item);
          else
            newList.push({ area: mustBuyForm.area, items: [mustBuyForm.item] });
          saveToFirebase("mustBuy", newList);
          setMustBuyForm((p) => ({ ...p, item: "" }));
        };
        const delMustBuy = (zIdx, iIdx) => {
          const newList = [...data.mustBuy];
          newList[zIdx].items.splice(iIdx, 1);
          saveToFirebase("mustBuy", newList);
        };
        const addExp = () => {
          if (!expenseForm.item || !expenseForm.total) return;
          const n = {
            id: Date.now(),
            date: new Date().toLocaleDateString("zh-TW", {
              month: "2-digit",
              day: "2-digit",
            }),
            item: expenseForm.item,
            total: Number(expenseForm.total),
            people: Number(expenseForm.people),
            perPerson: Math.round(expenseForm.total / expenseForm.people),
            payer: expenseForm.payer,
          };
          const newList = [n, ...data.expenses];
          saveToFirebase("expenses", newList);
          setExpenseForm({ ...expenseForm, item: "", total: "" });
        };
        const delExp = (id) => {
          if (confirm("刪除？")) {
            const newList = data.expenses.filter((e) => e.id !== id);
            saveToFirebase("expenses", newList);
          }
        };
        const resetData = () => {
          if (confirm("確定重置資料庫？")) {
            saveToFirebase("itinerary", DEFAULT_ITINERARY);
            saveToFirebase("shopping", []);
            saveToFirebase("mustBuy", DEFAULT_MUSTBUY);
            saveToFirebase("expenses", []);
          }
        };

        const Sidebar = () => (
          <aside className="hidden md:flex flex-col w-64 bg-white border-r h-screen sticky top-0 shadow-lg z-50">
            <div className="p-6 border-b border-gray-100">
              <h1 className="text-2xl font-black text-gray-800 tracking-tight flex items-center gap-2">
                Kansai <span className="text-sky-500">Trip</span>
              </h1>
              <div className="mt-2 flex items-center gap-2">
                <div
                  className={`w-2 h-2 rounded-full ${
                    user ? "bg-green-500 animate-pulse" : "bg-red-500"
                  }`}
                ></div>
                <span className="text-xs text-gray-500 font-medium">
                  {user
                    ? "Firebase 連線中"
                    : configError
                    ? "尚未設定 Firebase"
                    : "連線中斷"}
                </span>
              </div>
            </div>
            <nav className="flex-1 p-4 space-y-2">
              {[
                { id: "itinerary", icon: ICONS.calendar, label: "行程規劃" },
                { id: "shopping", icon: ICONS.shoppingBag, label: "購物清單" },
                { id: "tools", icon: ICONS.receipt, label: "記帳工具" },
                { id: "recommend", icon: ICONS.mapPin, label: "必買推薦" },
              ].map((t) => (
                <button
                  key={t.id}
                  onClick={() => setActiveTab(t.id)}
                  className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-bold ${
                    activeTab === t.id
                      ? "bg-sky-50 text-sky-600 shadow-sm"
                      : "text-gray-500 hover:bg-gray-50 hover:text-gray-700"
                  }`}
                >
                  <Icon path={t.icon} size={20} />
                  {t.label}
                </button>
              ))}
            </nav>
            <div className="p-4 border-t border-gray-100 bg-gray-50/50 space-y-3">
              <button
                onClick={resetData}
                className="w-full flex items-center justify-center gap-2 py-2 text-xs text-gray-400 hover:text-red-500 transition-colors"
              >
                <Icon path={ICONS.refresh} size={12} /> 重置資料庫
              </button>
            </div>
          </aside>
        );

        if (authLoading)
          return (
            <div className="flex h-screen w-full items-center justify-center bg-gray-50 flex-col gap-2">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-sky-500"></div>
              <div className="text-sky-600 font-bold text-sm">
                連線資料庫中...
              </div>
            </div>
          );

        return (
          <div className="min-h-screen bg-gray-50 md:flex relative">
            <Sidebar />
            <div className="flex-1 flex flex-col h-screen overflow-hidden">
              <div className="md:hidden bg-white/90 backdrop-blur-md px-4 py-3 sticky top-0 z-50 flex justify-between items-center border-b border-gray-100">
                <div className="flex flex-col">
                  <h1 className="text-xl font-black text-gray-800 tracking-tight flex items-center gap-2">
                    Kansai <span className="text-sky-500">Trip</span>
                  </h1>
                  <div className="flex items-center gap-1.5 mt-0.5">
                    <Icon
                      path={user ? ICONS.wifi : ICONS.wifiOff}
                      size={10}
                      className={user ? "text-green-500" : "text-red-500"}
                    />
                    <span className="text-[10px] text-gray-400 font-medium">
                      {user
                        ? "Live Sync"
                        : configError
                        ? "No Config"
                        : "Offline"}
                    </span>
                  </div>
                </div>
                <div className="bg-sky-50 text-sky-600 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider">
                  {activeTab === "tools"
                    ? "記帳"
                    : activeTab === "recommend"
                    ? "推薦"
                    : activeTab === "shopping"
                    ? "購物"
                    : "行程"}
                </div>
              </div>

              <div className="flex-1 overflow-y-auto p-4 md:p-8 pb-24 md:pb-8">
                <div className="max-w-7xl mx-auto w-full">
                  {configError && (
                    <div
                      className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"
                      role="alert"
                    >
                      <strong className="font-bold">尚未設定 Firebase!</strong>
                      <span className="block sm:inline">
                        {" "}
                        請用文字編輯器打開此檔案，填入 YOUR_FIREBASE_CONFIG。
                      </span>
                    </div>
                  )}

                  {activeTab === "itinerary" && (
                    <div className="space-y-4 animate-fade-in">
                      <div className="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-6">
                        <h2 className="font-bold text-gray-700 flex items-center gap-2 text-lg">
                          <Icon
                            path={ICONS.calendar}
                            size={24}
                            className="text-sky-500"
                          />{" "}
                          行程總覽
                        </h2>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 items-start">
                        {(data.itinerary || []).map((d, dIdx) => {
                          const color = DAY_COLORS[dIdx % DAY_COLORS.length];
                          return (
                            <DayCard
                              key={d.id}
                              day={d}
                              color={color}
                              isReordering={reorderingDayId === d.id}
                              toggleReorder={() =>
                                setReorderingDayId(
                                  reorderingDayId === d.id ? null : d.id
                                )
                              }
                              onUpdateEvents={onUpdateEvents}
                              onDeleteEvent={deleteItineraryEventLocal}
                              onEditEvent={setEditingEventId}
                              editingEventId={editingEventId}
                              onSaveEvent={saveSingleEvent}
                              updateItineraryLocal={updateItineraryLocal}
                            />
                          );
                        })}
                      </div>
                    </div>
                  )}

                  {activeTab === "shopping" && (
                    <div className="space-y-6 mt-2 animate-fade-in h-full flex flex-col">
                      <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-3 sticky top-0 z-40 md:static md:max-w-2xl md:mx-auto w-full">
                        <h2 className="hidden md:flex font-bold text-gray-700 items-center gap-2 mb-2">
                          <Icon path={ICONS.shoppingBag} size={20} />{" "}
                          新增購物項目
                        </h2>
                        <div className="flex gap-2">
                          <input
                            value={newItem.name}
                            onChange={(e) =>
                              setNewItem({ ...newItem, name: e.target.value })
                            }
                            placeholder="想買什麼？"
                            className="flex-1 p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm focus:bg-white transition-colors"
                          />
                          <input
                            type="number"
                            value={newItem.qty}
                            onChange={(e) =>
                              setNewItem({ ...newItem, qty: e.target.value })
                            }
                            placeholder="數"
                            className="w-16 p-2 bg-gray-50 rounded-xl border border-gray-200 text-center text-sm focus:bg-white transition-colors"
                          />
                        </div>
                        <div className="flex gap-2">
                          <input
                            value={newItem.note}
                            onChange={(e) =>
                              setNewItem({ ...newItem, note: e.target.value })
                            }
                            placeholder="備註 (規格、顏色...)"
                            className="flex-1 p-2.5 bg-gray-50 rounded-xl border border-gray-200 text-xs focus:bg-white transition-colors"
                          />
                          <button
                            onClick={addShop}
                            className="bg-sky-500 hover:bg-sky-600 text-white px-6 rounded-xl font-bold shadow-lg shadow-sky-200 active:scale-95 transition-all flex items-center gap-1"
                          >
                            <Icon path={ICONS.plus} size={20} />
                          </button>
                        </div>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-10">
                        {(data.shopping || []).map((i) => (
                          <div
                            key={i.id}
                            className={`bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-start gap-3 transition-all hover:shadow-md ${
                              i.checked ? "bg-gray-50 opacity-60" : ""
                            }`}
                          >
                            <button
                              onClick={() => toggleShop(i.id)}
                              className={`mt-0.5 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors flex-shrink-0 ${
                                i.checked
                                  ? "bg-sky-500 border-sky-500 text-white"
                                  : "border-gray-300 hover:border-sky-400"
                              }`}
                            >
                              {i.checked && (
                                <Icon
                                  path={ICONS.check}
                                  size={14}
                                  strokeWidth="3"
                                />
                              )}
                            </button>
                            <div
                              className="flex-1 min-w-0 cursor-pointer"
                              onClick={() => toggleShop(i.id)}
                            >
                              <div
                                className={`font-bold text-base text-gray-800 truncate ${
                                  i.checked ? "line-through text-gray-400" : ""
                                }`}
                              >
                                {i.name}
                              </div>
                              <div className="text-sm text-gray-500 mt-1 flex gap-2 items-center">
                                <span className="font-mono bg-gray-100 px-2 py-0.5 rounded text-gray-600 font-bold text-xs">
                                  x{i.qty}
                                </span>
                                {i.note && (
                                  <span className="truncate flex-1">
                                    {i.note}
                                  </span>
                                )}
                              </div>
                            </div>
                            <button
                              onClick={() => delShop(i.id)}
                              className="text-gray-300 hover:text-red-500 p-2 active:bg-red-50 rounded-full transition-colors"
                            >
                              <Icon path={ICONS.trash} size={18} />
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {activeTab === "tools" && (
                    <div className="mt-2 animate-fade-in flex flex-col md:flex-row gap-6 items-start">
                      <div className="w-full md:w-80 md:sticky md:top-6 space-y-5">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-purple-100 relative overflow-hidden">
                          <div className="absolute top-0 right-0 w-20 h-20 bg-purple-50 rounded-bl-full -mr-4 -mt-4 z-0"></div>
                          <div className="relative z-10">
                            <div className="flex items-center gap-2 font-bold text-gray-700 mb-4 text-lg">
                              <div className="p-1.5 bg-purple-100 rounded-lg text-purple-600">
                                <Icon path={ICONS.receipt} size={20} />
                              </div>
                              新增記帳
                            </div>
                            <div className="space-y-4">
                              <input
                                placeholder="消費項目 (例如: 晚餐)"
                                value={expenseForm.item}
                                onChange={(e) =>
                                  setExpenseForm({
                                    ...expenseForm,
                                    item: e.target.value,
                                  })
                                }
                                className="w-full border border-gray-200 bg-gray-50 p-3 rounded-xl text-sm focus:bg-white transition-colors"
                              />
                              <div className="grid grid-cols-2 gap-3">
                                <div className="relative">
                                  <span className="absolute left-3 top-2.5 text-gray-400 text-sm">
                                    ¥
                                  </span>
                                  <input
                                    type="number"
                                    placeholder="總金額"
                                    value={expenseForm.total}
                                    onChange={(e) =>
                                      setExpenseForm({
                                        ...expenseForm,
                                        total: e.target.value,
                                      })
                                    }
                                    className="border border-gray-200 bg-gray-50 p-2.5 pl-7 rounded-xl w-full text-sm font-mono focus:bg-white transition-colors"
                                  />
                                </div>
                                <div className="relative flex items-center">
                                  <input
                                    type="number"
                                    placeholder="人數"
                                    value={expenseForm.people}
                                    onChange={(e) =>
                                      setExpenseForm({
                                        ...expenseForm,
                                        people: e.target.value,
                                      })
                                    }
                                    className="border border-gray-200 bg-gray-50 p-2.5 rounded-xl w-full text-center text-sm focus:bg-white transition-colors"
                                  />
                                  <span className="absolute right-3 text-gray-400 text-xs">
                                    人
                                  </span>
                                </div>
                              </div>
                              <div className="bg-purple-50 p-3 rounded-xl flex justify-between items-center border border-purple-100">
                                <span className="text-purple-700 text-xs font-bold">
                                  每人分擔
                                </span>
                                <span className="text-xl font-bold text-purple-700 font-mono">
                                  ¥{" "}
                                  {expenseForm.total && expenseForm.people
                                    ? Math.round(
                                        expenseForm.total / expenseForm.people
                                      ).toLocaleString()
                                    : 0}
                                </span>
                              </div>
                              <button
                                onClick={addExp}
                                className="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-purple-200 active:scale-95 transition-all"
                              >
                                加入紀錄
                              </button>
                            </div>
                          </div>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                          <a
                            href="https://weather.yahoo.co.jp/weather/jp/27/6200.html"
                            target="_blank"
                            className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center justify-center gap-2 text-blue-500 font-bold text-xs hover:bg-blue-50 transition-colors"
                          >
                            <Icon path={ICONS.externalLink} size={14} />{" "}
                            大阪天氣
                          </a>
                          <a
                            href="https://translate.google.com/?sl=zh-TW&tl=ja"
                            target="_blank"
                            className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center justify-center gap-2 text-gray-600 font-bold text-xs hover:bg-gray-50 transition-colors"
                          >
                            <Icon path={ICONS.globe} size={14} /> Google 翻譯
                          </a>
                        </div>
                      </div>
                      <div className="flex-1 w-full space-y-3">
                        <h3 className="hidden md:block font-bold text-gray-700 text-lg mb-4">
                          消費紀錄
                        </h3>
                        {(!data.expenses || data.expenses.length === 0) && (
                          <div className="text-center py-10 text-gray-400 text-sm bg-white rounded-xl border border-gray-100 border-dashed">
                            尚無消費紀錄
                          </div>
                        )}
                        {(data.expenses || []).map((ex) => (
                          <div
                            key={ex.id}
                            className="flex justify-between items-center text-sm bg-white p-4 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow"
                          >
                            <div className="flex gap-4 items-center">
                              <div className="bg-gray-100 text-gray-500 text-xs font-bold px-3 py-2 rounded-lg text-center leading-tight">
                                {ex.date.split("/")[0]}
                                <br />
                                <span className="text-lg text-gray-700">
                                  {ex.date.split("/")[1]}
                                </span>
                              </div>
                              <div>
                                <div className="font-bold text-gray-800 text-base">
                                  {ex.item}
                                </div>
                                <div className="text-xs text-gray-400 mt-0.5">
                                  總計 ¥{ex.total.toLocaleString()} /{" "}
                                  {ex.people}人
                                </div>
                              </div>
                            </div>
                            <div className="flex items-center gap-4">
                              <div className="text-right">
                                <div className="text-[10px] text-purple-400 font-bold mb-0.5">
                                  每人
                                </div>
                                <span className="font-bold text-purple-600 font-mono text-lg">
                                  ¥{ex.perPerson.toLocaleString()}
                                </span>
                              </div>
                              <button
                                onClick={() => delExp(ex.id)}
                                className="text-gray-300 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-colors"
                              >
                                <Icon path={ICONS.x} size={16} />
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {activeTab === "recommend" && (
                    <div className="space-y-6 mt-2 animate-fade-in">
                      <div className="bg-white p-5 rounded-2xl shadow-sm border border-orange-100 space-y-3 sticky top-0 z-40 md:static md:max-w-2xl md:mx-auto">
                        <h2 className="hidden md:flex font-bold text-gray-700 items-center gap-2 mb-2">
                          <Icon path={ICONS.mapPin} size={20} /> 新增推薦
                        </h2>
                        <div className="flex gap-2">
                          <input
                            value={mustBuyForm.area}
                            onChange={(e) =>
                              setMustBuyForm({
                                ...mustBuyForm,
                                area: e.target.value,
                              })
                            }
                            list="area-list"
                            placeholder="區域 (例如: 梅田)"
                            className="w-1/3 p-3 bg-orange-50 rounded-xl border border-orange-200 text-sm focus:bg-white transition-colors"
                          />
                          <datalist id="area-list">
                            {(data.mustBuy || []).map((z) => (
                              <option key={z.area} value={z.area} />
                            ))}
                          </datalist>
                          <input
                            value={mustBuyForm.item}
                            onChange={(e) =>
                              setMustBuyForm({
                                ...mustBuyForm,
                                item: e.target.value,
                              })
                            }
                            placeholder="必買商品 / 美食"
                            className="flex-1 p-3 bg-orange-50 rounded-xl border border-orange-200 text-sm focus:bg-white transition-colors"
                          />
                        </div>
                        <button
                          onClick={addMustBuy}
                          className="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-orange-200 active:scale-95 transition-transform flex justify-center items-center gap-2"
                        >
                          <Icon path={ICONS.plus} size={20} /> 新增推薦
                        </button>
                      </div>
                      <div className="columns-1 md:columns-2 lg:columns-3 gap-6 space-y-6 pb-10">
                        {(data.mustBuy || []).map((z, zIdx) => (
                          <div
                            key={zIdx}
                            className="break-inside-avoid bg-white rounded-2xl shadow-sm border border-orange-100 overflow-hidden hover:shadow-md transition-shadow"
                          >
                            <div className="bg-orange-50 px-4 py-3 font-bold text-orange-800 flex gap-2 items-center text-sm border-b border-orange-100">
                              <Icon path={ICONS.mapPin} size={16} /> {z.area}
                            </div>
                            <div className="p-4 grid grid-cols-1 gap-2">
                              {z.items.map((it, iIdx) => (
                                <div
                                  key={iIdx}
                                  className="bg-white p-3 rounded-lg text-sm text-gray-700 flex justify-between items-center border border-gray-100 shadow-sm hover:border-orange-200 transition-colors"
                                >
                                  <span className="truncate pl-1 font-medium">
                                    {it}
                                  </span>
                                  <button
                                    onClick={() => delMustBuy(zIdx, iIdx)}
                                    className="text-gray-300 hover:text-red-400 p-1 rounded hover:bg-red-50 transition-colors"
                                  >
                                    <Icon path={ICONS.x} size={14} />
                                  </button>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </div>

              <div className="md:hidden fixed bottom-0 w-full bg-white/95 backdrop-blur border-t border-gray-200 pb-safe z-50 safe-bottom">
                <div className="flex justify-around items-center h-14">
                  {[
                    { id: "itinerary", icon: ICONS.calendar, label: "行程" },
                    { id: "shopping", icon: ICONS.shoppingBag, label: "購物" },
                    { id: "tools", icon: ICONS.receipt, label: "記帳" },
                    { id: "recommend", icon: ICONS.mapPin, label: "必買" },
                  ].map((t) => (
                    <button
                      key={t.id}
                      onClick={() => setActiveTab(t.id)}
                      className={`flex flex-col items-center justify-center w-full h-full transition-colors active:scale-90 duration-200 ${
                        activeTab === t.id
                          ? "text-sky-500"
                          : "text-gray-400 hover:text-gray-600"
                      }`}
                    >
                      <Icon
                        path={t.icon}
                        size={22}
                        className={activeTab === t.id ? "drop-shadow-sm" : ""}
                      />
                      <span className="text-[10px] mt-0.5 font-medium">
                        {t.label}
                      </span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
