<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Kansai Trip 2025 (App Style)</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&family=Zen+Old+Mincho:wght@400;700;900&family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "app-bg": "#f0f4f8",
              "app-blue": "#4a90e2",
              "app-blue-dark": "#357abd",
              "app-text": "#2d3436",
              "app-sub": "#636e72",
              "card-bg": "rgba(255, 255, 255, 0.85)",
            },
            fontFamily: {
              sans: ['"Zen Maru Gothic"', '"Inter"', "sans-serif"],
              serif: ['"Zen Old Mincho"', "serif"],
            },
            boxShadow: {
              glass: "0 8px 32px 0 rgba(31, 38, 135, 0.15)",
              float: "0 10px 40px -10px rgba(0,0,0,0.1)",
            },
            backgroundImage: {
              "osaka-bg":
                "url('https://images.unsplash.com/photo-1590253230534-d784eb093a7d?q=80&w=2000&auto=format&fit=crop')",
            },
          },
        },
      };
    </script>

    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- React & ReactDOM -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        onSnapshot,
        setDoc,
        collection,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      window.Firebase = {
        initializeApp,
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
        getFirestore,
        doc,
        onSnapshot,
        setDoc,
        collection,
      };
    </script>

    <style>
      body {
        -webkit-tap-highlight-color: transparent;
        background-color: #f0f4f8;
        color: #2d3436;
        user-select: none;
        font-family: "Zen Maru Gothic", sans-serif;
        height: 100dvh;
        overflow: hidden;
      }

      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* Desktop Scrollbar Styling */
      @media (min-width: 768px) {
        .custom-scrollbar::-webkit-scrollbar {
          width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.4);
          border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: rgba(255, 255, 255, 0.6);
        }
      }

      .glass-panel {
        background: rgba(255, 255, 255, 0.65);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }

      .glass-card {
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      }

      .trans-all {
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef, useCallback, memo, useMemo } = React;

      // =================================================================================
      const YOUR_FIREBASE_CONFIG = {
        apiKey: "AIzaSyCH2awCY1eWCKO03nCc3ixJiOGtoz1u5tg",
        authDomain: "travel-app-4560d.firebaseapp.com",
        projectId: "travel-app-4560d",
        storageBucket: "travel-app-4560d.firebasestorage.app",
        messagingSenderId: "813547420756",
        appId: "1:813547420756:web:f6f21c91b28556627741c1",
      };
      const APP_ID = "my-kansai-trip-2025";
      // =================================================================================

      const TIME_OPTIONS = (() => {
        const options = ["待定"];
        for (let h = 0; h < 24; h++) {
          for (let m = 0; m < 60; m += 15) {
            options.push(
              `${h.toString().padStart(2, "0")}:${m
                .toString()
                .padStart(2, "0")}`
            );
          }
        }
        return options;
      })();

      const DEFAULT_ITINERARY = [
        {
          id: 1,
          date: "2/6 (五)",
          title: "Day 1: 抵達大阪",
          events: [
            {
              id: "e1",
              time: "10:55",
              location: "關西機場 (KIX)",
              transport: "入境",
              note: "航班：IT210\n抵達後前往二樓",
              type: "flight",
            },
            {
              id: "e2",
              time: "12:00",
              location: "南海電鐵",
              transport: "Rapit 特急",
              note: "搭乘 Rapit 到難波",
              type: "transport",
            },
          ],
        },
        {
          id: 2,
          date: "2/7 (六)",
          title: "Day 2: 大阪城",
          events: [],
        },
      ];

      const DEFAULT_MUSTBUY = [
        { area: "梅田", items: ["Baton d'or", "Grand Calbee"] },
        { area: "京都", items: ["茶之菓", "京年輪蛋糕"] },
      ];

      const DEFAULT_MEMBERS = ["我", "旅伴"];

      const ICONS = {
        map: "M9 20l-5.447 2.724A1 1 0 012 21.832V4.168a1 1 0 011.447-.894L9 6m0 14l6-3m-6 3V6m6 14l5.447 2.724A1 1 0 0022 21.832V4.168a1 1 0 00-1.447-.894L15 6m0 14V6m0 0L9 3",
        home: "M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6",
        calendar:
          "M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z",
        shoppingBag: "M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z",
        wallet:
          "M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z",
        info: "M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
        plus: "M12 4v16m8-8H4",
        x: "M6 18L18 6M6 6l12 12",
        edit: "M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z",
        trash:
          "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16",
        check: "M5 13l4 4L19 7",
        plane: "M12 19l9 2-9-18-9 18 9-2zm0 0v-8",
        train:
          "M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z M2 22h20",
        pin: "M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z",
        mount: "M12 3l9 16H3l9-16z",
        grip: "M3 12h18 M3 6h18 M3 18h18",
        globe:
          "M2 12h20 M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z",
        externalLink:
          "M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6 M15 3h6v6 M10 14L21 3",
        sort: "M4 6h16 M4 12h16 M4 18h16",
      };

      const Icon = ({
        path,
        size = 20,
        className = "",
        onClick,
        viewBox = "0 0 24 24",
      }) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width={size}
          height={size}
          viewBox={viewBox}
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          className={className}
          onClick={onClick}
          style={{ cursor: onClick ? "pointer" : "default" }}
        >
          <path d={path} />
        </svg>
      );

      const LinkifiedText = ({ text }) => {
        if (!text) return null;
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const parts = text.split(urlRegex);
        return (
          <>
            {parts.map((part, index) =>
              part.match(urlRegex) ? (
                <a
                  key={index}
                  href={part}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-app-blue hover:text-app-blue-dark hover:underline break-all relative z-10 font-bold"
                  onClick={(e) => e.stopPropagation()}
                >
                  {part}
                </a>
              ) : (
                part
              )
            )}
          </>
        );
      };

      const ConfirmModal = ({ isOpen, message, onConfirm, onCancel }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
            <div
              className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity"
              onClick={onCancel}
            ></div>
            <div className="bg-white rounded-3xl shadow-2xl p-6 max-w-xs w-full relative z-10 animate-[pop_0.3s_ease-out]">
              <h3 className="font-bold text-gray-800 text-lg text-center mb-6">
                {message}
              </h3>
              <div className="flex gap-3">
                <button
                  onClick={onCancel}
                  className="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-2xl font-bold transition-colors"
                >
                  取消
                </button>
                <button
                  onClick={onConfirm}
                  className="flex-1 py-3 bg-app-blue hover:bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-200 transition-colors"
                >
                  確定
                </button>
              </div>
            </div>
          </div>
        );
      };

      // --- Main Component ---
      const App = () => {
        const [activeTab, setActiveTab] = useState("itinerary");
        const [user, setUser] = useState(null);
        const [db, setDb] = useState(null);
        const [authLoading, setAuthLoading] = useState(true);
        const [data, setData] = useState({
          itinerary: DEFAULT_ITINERARY,
          shopping: [],
          mustBuy: [],
          expenses: [],
          info: [],
          settings: { members: DEFAULT_MEMBERS },
        });

        // UI States
        const [selectedDayId, setSelectedDayId] = useState(1);
        const [modalConfig, setModalConfig] = useState({
          isOpen: false,
          message: "",
          onConfirm: () => {},
          onCancel: () => {},
        });
        const [reorderingDayId, setReorderingDayId] = useState(null);

        // Forms
        const [expenseForm, setExpenseForm] = useState({
          item: "",
          total: "",
          payer: "",
          involved: [],
        });
        const [editingExpenseId, setEditingExpenseId] = useState(null);
        const [editingEventId, setEditingEventId] = useState(null);
        const [newItem, setNewItem] = useState({ name: "", qty: 1, note: "" });
        const [mustBuyForm, setMustBuyForm] = useState({ area: "", item: "" });
        const [infoForm, setInfoForm] = useState({
          title: "",
          link: "",
          note: "",
        });
        const [newMemberName, setNewMemberName] = useState("");

        // --- Firebase Init & Listeners ---
        useEffect(() => {
          const initFirebase = async () => {
            if (!window.Firebase) return;
            try {
              const app = window.Firebase.initializeApp(YOUR_FIREBASE_CONFIG);
              const auth = window.Firebase.getAuth(app);
              const firestore = window.Firebase.getFirestore(app);
              setDb(firestore);
              await window.Firebase.signInAnonymously(auth);
              window.Firebase.onAuthStateChanged(auth, (u) => {
                setUser(u);
                setAuthLoading(false);
              });
            } catch (e) {
              console.error(e);
              setAuthLoading(false);
            }
          };
          initFirebase();
        }, []);

        useEffect(() => {
          if (!user || !db) return;
          const publicPath = `artifacts/${APP_ID}/public/data/trip_data`;
          const setupListener = (docName, dataKey, defaultVal) => {
            return window.Firebase.onSnapshot(
              window.Firebase.doc(
                window.Firebase.collection(db, publicPath),
                docName
              ),
              (snap) => {
                if (snap.exists())
                  setData((p) => ({
                    ...p,
                    [dataKey]: snap.data().list || snap.data(),
                  }));
                else if (defaultVal)
                  setData((p) => ({ ...p, [dataKey]: defaultVal }));
              }
            );
          };
          const unsubs = [
            setupListener("itinerary", "itinerary", DEFAULT_ITINERARY),
            setupListener("shopping", "shopping", []),
            setupListener("mustBuy", "mustBuy", DEFAULT_MUSTBUY),
            setupListener("expenses", "expenses", []),
            setupListener("info", "info", []),
            setupListener("settings", "settings", { members: DEFAULT_MEMBERS }),
          ];
          return () => unsubs.forEach((u) => u());
        }, [user, db]);

        const saveToFirebase = async (key, val) => {
          if (!user || !db) return;
          const payload = key === "settings" ? val : { list: val };
          await window.Firebase.setDoc(
            window.Firebase.doc(
              window.Firebase.collection(
                db,
                `artifacts/${APP_ID}/public/data/trip_data`
              ),
              key
            ),
            payload
          );
        };

        const openConfirm = (msg, cb) =>
          setModalConfig({
            isOpen: true,
            message: msg,
            onConfirm: () => {
              cb();
              setModalConfig((p) => ({ ...p, isOpen: false }));
            },
            onCancel: () => setModalConfig((p) => ({ ...p, isOpen: false })),
          });

        // --- Logic Handlers ---
        useEffect(() => {
          if (
            data.settings?.members &&
            !expenseForm.payer &&
            !editingExpenseId &&
            expenseForm.involved.length === 0
          ) {
            setExpenseForm((p) => ({
              ...p,
              payer: data.settings.members[0] || "",
              involved: [...data.settings.members],
            }));
          }
        }, [data.settings, editingExpenseId]);

        const handleExpenseSubmit = () => {
          if (!expenseForm.item || !expenseForm.total) return;
          const totalVal = Number(expenseForm.total);
          const entry = {
            id: editingExpenseId || Date.now(),
            date: new Date().toLocaleDateString("zh-TW", {
              month: "2-digit",
              day: "2-digit",
            }),
            item: expenseForm.item,
            total: totalVal,
            payer: expenseForm.payer,
            involved: expenseForm.involved,
            perPerson: Math.round(
              totalVal / (expenseForm.involved.length || 1)
            ),
          };
          let newList = data.expenses;
          if (editingExpenseId)
            newList = newList.map((e) =>
              e.id === editingExpenseId ? entry : e
            );
          else newList = [entry, ...newList];
          saveToFirebase("expenses", newList);
          setExpenseForm({
            item: "",
            total: "",
            payer: data.settings.members[0] || "",
            involved: [...data.settings.members],
          });
          setEditingExpenseId(null);
        };

        const toggleInvolved = (m) => {
          setExpenseForm((p) => ({
            ...p,
            involved: p.involved.includes(m)
              ? p.involved.filter((x) => x !== m)
              : [...p.involved, m],
          }));
        };

        const updateItineraryLocal = (dId, eId, k, v) => {
          const newList = data.itinerary.map((d) =>
            d.id !== dId
              ? d
              : {
                  ...d,
                  events: d.events.map((e) =>
                    e.id === eId ? { ...e, [k]: v } : e
                  ),
                }
          );
          setData((p) => ({ ...p, itinerary: newList }));
        };
        const saveSingleEvent = () => {
          saveToFirebase("itinerary", data.itinerary);
          setEditingEventId(null);
        };
        const onUpdateEvents = (dId, newEvents) => {
          const newData = data.itinerary.map((d) =>
            d.id === dId ? { ...d, events: newEvents } : d
          );
          setData((p) => ({ ...p, itinerary: newData }));
          saveToFirebase("itinerary", newData);
        };
        const deleteItineraryEventLocal = (dId, eId) => {
          openConfirm("確定要刪除此行程活動嗎？", () => {
            const newList = data.itinerary.map((d) =>
              d.id === dId
                ? { ...d, events: d.events.filter((e) => e.id !== eId) }
                : d
            );
            setData((p) => ({ ...p, itinerary: newList }));
            saveToFirebase("itinerary", newList);
            setEditingEventId(null);
          });
        };
        const addItineraryEventLocal = (dId) => {
          const newId = `new_${Date.now()}`;
          const newList = data.itinerary.map((d) =>
            d.id === dId
              ? {
                  ...d,
                  events: [
                    ...d.events,
                    {
                      id: newId,
                      time: "待定",
                      location: "新地點",
                      transport: "",
                      note: "",
                    },
                  ],
                }
              : d
          );
          setData((p) => ({ ...p, itinerary: newList }));
          saveToFirebase("itinerary", newList);
          setEditingEventId(newId);
        };

        // --- Sortable Component ---
        const SortableDayList = ({
          day,
          isReordering,
          onUpdateEvents,
          children,
        }) => {
          const listRef = useRef(null);
          const sortableRef = useRef(null);

          useEffect(() => {
            if (isReordering && listRef.current && window.Sortable) {
              sortableRef.current = new window.Sortable(listRef.current, {
                handle: ".drag-handle",
                animation: 150,
                ghostClass: "opacity-50",
                onEnd: (evt) => {
                  const newEvents = [...day.events];
                  const [moved] = newEvents.splice(evt.oldIndex, 1);
                  newEvents.splice(evt.newIndex, 0, moved);
                  onUpdateEvents(day.id, newEvents);
                },
              });
            } else if (!isReordering && sortableRef.current) {
              sortableRef.current.destroy();
              sortableRef.current = null;
            }
          }, [isReordering]);

          return (
            <div ref={listRef} className="space-y-4">
              {children}
            </div>
          );
        };

        const DayCard = ({
          day,
          color,
          isReordering,
          toggleReorder,
          onUpdateEvents,
          onDeleteEvent,
          onEditEvent,
          editingEventId,
          onSaveEvent,
          updateItineraryLocal,
          onAddEvent,
        }) => {
          return null;
        };

        // --- Render Functions ---
        // 1. Sidebar for Desktop
        const renderNav = () => {
          const tabs = [
            { id: "itinerary", icon: ICONS.map, label: "行程" },
            { id: "shopping", icon: ICONS.shoppingBag, label: "購物" },
            { id: "tools", icon: ICONS.wallet, label: "記帳" },
            { id: "recommend", icon: ICONS.mount, label: "推薦" },
            { id: "info", icon: ICONS.info, label: "資訊" },
          ];

          return (
            <aside className="hidden md:flex w-72 flex-col bg-white/60 backdrop-blur-xl border-r border-white/40 h-full p-6 shadow-xl z-20">
              <div className="mb-10 pl-2">
                <div className="text-xs font-bold text-gray-500 mb-1 tracking-widest">
                  MENU
                </div>
                <div className="h-1 w-10 bg-app-blue rounded-full"></div>
              </div>
              <nav className="space-y-3">
                {tabs.map((t) => (
                  <button
                    key={t.id}
                    onClick={() => setActiveTab(t.id)}
                    className={`w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all duration-300 group ${
                      activeTab === t.id
                        ? "bg-white shadow-lg text-app-blue scale-105"
                        : "hover:bg-white/50 text-gray-600 hover:text-gray-800"
                    }`}
                  >
                    <div
                      className={`p-2 rounded-xl transition-colors ${
                        activeTab === t.id
                          ? "bg-blue-50"
                          : "bg-white/50 group-hover:bg-white"
                      }`}
                    >
                      <Icon path={t.icon} size={22} />
                    </div>
                    <span className="font-bold text-lg tracking-wide">
                      {t.label}
                    </span>
                  </button>
                ))}
              </nav>
              <div className="mt-auto bg-white/50 rounded-3xl p-5 border border-white/60">
                <div className="text-xs font-bold text-gray-400 mb-2">
                  CURRENT LOCATION
                </div>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-blue-100 text-blue-600 rounded-full">
                    <Icon path={ICONS.pin} size={18} />
                  </div>
                  <div>
                    <div className="font-bold text-gray-800">Osaka</div>
                    <div className="text-xs text-gray-500">Japan</div>
                  </div>
                </div>
              </div>
            </aside>
          );
        };

        // 2. Floating Nav for Mobile
        const renderFloatingNav = () => (
          <div className="md:hidden fixed bottom-6 inset-x-6 h-16 bg-white/90 backdrop-blur-md rounded-full shadow-float flex items-center justify-around z-50 border border-white/40 max-w-md mx-auto">
            {[
              { id: "itinerary", icon: ICONS.map, label: "行程" },
              { id: "shopping", icon: ICONS.shoppingBag, label: "購物" },
              { id: "tools", icon: ICONS.wallet, label: "記帳" },
              { id: "recommend", icon: ICONS.mount, label: "推薦" },
              { id: "info", icon: ICONS.info, label: "資訊" },
            ].map((t) => (
              <button
                key={t.id}
                onClick={() => setActiveTab(t.id)}
                className={`flex flex-col items-center justify-center w-12 h-12 rounded-full transition-all duration-300 ${
                  activeTab === t.id
                    ? "text-app-blue bg-blue-50 transform -translate-y-2 shadow-sm"
                    : "text-gray-400 hover:text-gray-600"
                }`}
              >
                <Icon
                  path={t.icon}
                  size={22}
                  className={activeTab === t.id ? "stroke-[2.5px]" : ""}
                />
                {activeTab !== t.id && (
                  <span className="text-[9px] font-bold mt-0.5">{t.label}</span>
                )}
              </button>
            ))}
          </div>
        );

        const renderHeader = () => (
          <div className="flex-shrink-0 pt-safe pb-4 px-6 md:px-10 flex justify-between items-end bg-white/30 backdrop-blur-sm border-b border-white/40 md:bg-transparent md:border-none md:pt-10">
            <div>
              <h1 className="text-2xl md:text-4xl font-black text-gray-800 tracking-wider font-serif flex items-center gap-2 drop-shadow-sm">
                KANSAI{" "}
                <span className="text-xs md:text-sm bg-app-blue text-white px-2 py-0.5 rounded-full font-sans font-bold shadow-sm">
                  TRIP
                </span>
              </h1>
              <div className="flex items-center gap-2 mt-1">
                <div
                  className={`w-2 h-2 rounded-full ${
                    user ? "bg-green-400" : "bg-red-400"
                  } shadow-sm`}
                ></div>
                <span className="text-xs md:text-sm text-gray-600 font-bold tracking-wide">
                  1 JPY ≈ 0.21 TWD
                </span>
              </div>
            </div>
            <div className="text-right hidden md:block">
              <span className="text-4xl font-black text-white drop-shadow-md font-sans">
                Osaka
              </span>
            </div>
          </div>
        );

        const renderItineraryView = () => {
          const currentDay =
            (data.itinerary || []).find((d) => d.id === selectedDayId) ||
            data.itinerary[0];
          return (
            <div className="flex flex-col h-full">
              <div className="flex overflow-x-auto gap-3 px-6 md:px-10 py-4 no-scrollbar flex-shrink-0">
                {(data.itinerary || []).map((d, idx) => {
                  const isSelected = selectedDayId === d.id;
                  const dayNum = `Day ${idx + 1}`;
                  const dateStr = d.date.split(" ")[0];
                  return (
                    <button
                      key={d.id}
                      onClick={() => setSelectedDayId(d.id)}
                      className={`flex flex-col items-center justify-center min-w-[70px] h-[70px] rounded-2xl transition-all duration-300 ${
                        isSelected
                          ? "bg-white shadow-lg scale-105"
                          : "bg-white/40 hover:bg-white/60"
                      }`}
                    >
                      <span
                        className={`text-[10px] font-bold mb-0.5 ${
                          isSelected ? "text-app-blue" : "text-gray-400"
                        }`}
                      >
                        {dayNum}
                      </span>
                      <span
                        className={`text-lg font-black font-sans ${
                          isSelected ? "text-gray-800" : "text-gray-500"
                        }`}
                      >
                        {dateStr}
                      </span>
                    </button>
                  );
                })}
              </div>
              <div className="flex-1 overflow-y-auto px-6 md:px-10 pb-32 md:pb-10 custom-scrollbar">
                {currentDay ? (
                  <div className="max-w-5xl mx-auto">
                    <div className="flex justify-between items-center mb-6">
                      <h2 className="text-2xl font-black text-gray-800 font-serif">
                        {currentDay.title}
                      </h2>
                      <button
                        onClick={() =>
                          setReorderingDayId(
                            reorderingDayId === currentDay.id
                              ? null
                              : currentDay.id
                          )
                        }
                        className={`p-2 rounded-xl transition-all ${
                          reorderingDayId === currentDay.id
                            ? "bg-app-blue text-white shadow-md"
                            : "bg-white/50 text-gray-600 hover:bg-white"
                        }`}
                      >
                        <Icon
                          path={reorderingDayId ? ICONS.check : ICONS.sort}
                          size={20}
                        />
                      </button>
                    </div>

                    <SortableDayList
                      day={currentDay}
                      isReordering={reorderingDayId === currentDay.id}
                      onUpdateEvents={(dId, evs) => onUpdateEvents(dId, evs)}
                    >
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                        {currentDay.events.map((e) => {
                          const isEditing = editingEventId === e.id;
                          return (
                            <div
                              key={e.id}
                              className={`relative group transition-all duration-300 ${
                                isEditing ? "z-20 scale-[1.02]" : ""
                              }`}
                            >
                              {isEditing ? (
                                <div className="glass-card rounded-3xl p-5 shadow-xl ring-4 ring-blue-100">
                                  <div className="space-y-3">
                                    <div className="flex gap-2">
                                      <select
                                        value={e.time}
                                        onChange={(ev) =>
                                          updateItineraryLocal(
                                            currentDay.id,
                                            e.id,
                                            "time",
                                            ev.target.value
                                          )
                                        }
                                        className="bg-gray-50 rounded-xl px-3 py-2 text-sm font-bold text-center w-24"
                                      >
                                        {TIME_OPTIONS.map((t) => (
                                          <option key={t}>{t}</option>
                                        ))}
                                      </select>
                                      <input
                                        value={e.location}
                                        onChange={(ev) =>
                                          updateItineraryLocal(
                                            currentDay.id,
                                            e.id,
                                            "location",
                                            ev.target.value
                                          )
                                        }
                                        className="flex-1 bg-gray-50 rounded-xl px-3 py-2 text-sm font-bold"
                                        placeholder="地點"
                                      />
                                    </div>
                                    <input
                                      value={e.transport}
                                      onChange={(ev) =>
                                        updateItineraryLocal(
                                          currentDay.id,
                                          e.id,
                                          "transport",
                                          ev.target.value
                                        )
                                      }
                                      className="w-full bg-gray-50 rounded-xl px-3 py-2 text-xs"
                                      placeholder="交通方式"
                                    />
                                    <textarea
                                      value={e.note}
                                      onChange={(ev) =>
                                        updateItineraryLocal(
                                          currentDay.id,
                                          e.id,
                                          "note",
                                          ev.target.value
                                        )
                                      }
                                      className="w-full bg-gray-50 rounded-xl px-3 py-2 text-xs"
                                      rows="3"
                                      placeholder="備註"
                                    ></textarea>
                                    <div className="flex gap-2 pt-2">
                                      <button
                                        onClick={saveSingleEvent}
                                        className="flex-1 bg-green-500 text-white py-2 rounded-xl text-xs font-bold shadow-md"
                                      >
                                        儲存
                                      </button>
                                      <button
                                        onClick={() =>
                                          deleteItineraryEventLocal(
                                            currentDay.id,
                                            e.id
                                          )
                                        }
                                        className="px-3 bg-red-100 text-red-500 rounded-xl"
                                      >
                                        <Icon path={ICONS.trash} size={16} />
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              ) : (
                                <div className="glass-card rounded-3xl p-5 hover:bg-white/95 transition-colors h-full flex flex-col relative overflow-hidden">
                                  {reorderingDayId && (
                                    <div className="absolute top-2 right-2 text-app-blue drag-handle cursor-move">
                                      <Icon path={ICONS.grip} size={20} />
                                    </div>
                                  )}

                                  {e.type === "flight" ? (
                                    <div className="absolute top-0 right-0 w-24 h-24 bg-blue-500/10 rounded-full -mr-8 -mt-8 blur-xl pointer-events-none"></div>
                                  ) : null}

                                  <div className="flex justify-between items-start mb-3">
                                    <span className="font-mono text-xl font-black text-gray-700 bg-white/50 px-2 py-1 rounded-lg backdrop-blur-sm">
                                      {e.time}
                                    </span>
                                    {!reorderingDayId && (
                                      <button
                                        onClick={() => setEditingEventId(e.id)}
                                        className="text-gray-300 hover:text-app-blue transition-colors"
                                      >
                                        <Icon path={ICONS.edit} size={16} />
                                      </button>
                                    )}
                                  </div>
                                  <h3 className="text-lg font-bold text-gray-800 mb-2 leading-tight">
                                    {e.location}
                                  </h3>
                                  {e.transport && (
                                    <div className="inline-flex items-center gap-1.5 bg-blue-50 text-app-blue px-3 py-1 rounded-full text-xs font-bold mb-3 self-start border border-blue-100">
                                      <Icon path={ICONS.train} size={12} />{" "}
                                      {e.transport}
                                    </div>
                                  )}
                                  {e.note && (
                                    <div className="mt-auto pt-3 border-t border-gray-100 text-sm text-gray-500 whitespace-pre-line leading-relaxed">
                                      <LinkifiedText text={e.note} />
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          );
                        })}
                        {/* Add Button */}
                        {!reorderingDayId && (
                          <button
                            onClick={() =>
                              addItineraryEventLocal(currentDay.id)
                            }
                            className="border-3 border-dashed border-white/40 bg-white/10 hover:bg-white/30 rounded-3xl p-6 flex flex-col items-center justify-center gap-2 text-gray-600 hover:text-app-blue transition-all min-h-[180px] group"
                          >
                            <div className="w-12 h-12 rounded-full bg-white/50 flex items-center justify-center group-hover:scale-110 transition-transform shadow-sm">
                              <Icon path={ICONS.plus} size={24} />
                            </div>
                            <span className="font-bold">新增活動</span>
                          </button>
                        )}
                      </div>
                    </SortableDayList>
                  </div>
                ) : (
                  <div className="text-center pt-20 text-gray-500 font-bold">
                    請選擇日期
                  </div>
                )}
              </div>
            </div>
          );
        };

        const renderExpensesView = () => {
          const addMember = () => {
            if (!newMemberName.trim()) return;
            if (data.settings?.members?.includes(newMemberName.trim())) return;
            const newMembers = [
              ...(data.settings?.members || []),
              newMemberName.trim(),
            ];
            saveToFirebase("settings", {
              ...data.settings,
              members: newMembers,
            });
            setNewMemberName("");
          };
          const removeMember = (name) => {
            openConfirm(`確定要移除成員 ${name} 嗎？`, () => {
              const newMembers =
                data.settings?.members?.filter((m) => m !== name) || [];
              saveToFirebase("settings", {
                ...data.settings,
                members: newMembers,
              });
            });
          };

          return (
            <div className="h-full flex flex-col px-6 md:px-10 pb-32 md:pb-10 overflow-y-auto custom-scrollbar">
              <div className="max-w-6xl mx-auto w-full grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div className="lg:col-span-1 space-y-6">
                  <div className="glass-card rounded-3xl p-6 sticky top-6">
                    <h2 className="font-bold text-xl text-gray-800 mb-6 flex items-center gap-2">
                      <div className="bg-yellow-100 text-yellow-600 p-2 rounded-xl">
                        <Icon path={ICONS.wallet} size={20} />
                      </div>
                      {editingExpenseId ? "編輯消費" : "新增消費"}
                    </h2>
                    <div className="space-y-4">
                      <input
                        value={expenseForm.item}
                        onChange={(e) =>
                          setExpenseForm({
                            ...expenseForm,
                            item: e.target.value,
                          })
                        }
                        placeholder="消費項目"
                        className="w-full bg-gray-50 rounded-2xl px-4 py-3.5 text-sm font-bold focus:bg-white focus:ring-2 focus:ring-app-blue/20 transition-all"
                      />
                      <div className="flex gap-3">
                        <input
                          type="number"
                          value={expenseForm.total}
                          onChange={(e) =>
                            setExpenseForm({
                              ...expenseForm,
                              total: e.target.value,
                            })
                          }
                          placeholder="金額"
                          className="w-2/3 bg-gray-50 rounded-2xl px-4 py-3.5 text-sm font-bold font-mono focus:bg-white focus:ring-2 focus:ring-app-blue/20 transition-all"
                        />
                        <select
                          value={expenseForm.payer}
                          onChange={(e) =>
                            setExpenseForm({
                              ...expenseForm,
                              payer: e.target.value,
                            })
                          }
                          className="w-1/3 bg-gray-50 rounded-2xl px-2 py-3.5 text-sm font-bold focus:bg-white text-center cursor-pointer"
                        >
                          {(data.settings?.members || []).map((m) => (
                            <option key={m} value={m}>
                              {m}付
                            </option>
                          ))}
                        </select>
                      </div>
                      <div>
                        <label className="text-xs font-bold text-gray-400 ml-1 mb-2 block">
                          分擔者
                        </label>
                        <div className="flex flex-wrap gap-2">
                          {(data.settings?.members || []).map((m) => (
                            <button
                              key={m}
                              onClick={() => toggleInvolved(m)}
                              className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${
                                expenseForm.involved.includes(m)
                                  ? "bg-gray-800 text-white shadow-md transform scale-105"
                                  : "bg-gray-100 text-gray-500 hover:bg-gray-200"
                              }`}
                            >
                              {m}
                            </button>
                          ))}
                        </div>
                      </div>
                      <div className="flex gap-2 pt-2">
                        {editingExpenseId && (
                          <button
                            onClick={() => {
                              setEditingExpenseId(null);
                              setExpenseForm({
                                item: "",
                                total: "",
                                payer: data.settings.members[0],
                                involved: [...data.settings.members],
                              });
                            }}
                            className="w-1/3 bg-gray-200 text-gray-600 font-bold rounded-2xl"
                          >
                            取消
                          </button>
                        )}
                        <button
                          onClick={handleExpenseSubmit}
                          className="flex-1 bg-app-blue hover:bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-200 active:scale-95 transition-all"
                        >
                          {editingExpenseId ? "確認" : "記一筆"}
                        </button>
                      </div>
                    </div>
                  </div>

                  <div className="glass-card rounded-3xl p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-bold text-gray-700">成員管理</h3>
                      <div className="flex gap-2">
                        <input
                          value={newMemberName}
                          onChange={(e) => setNewMemberName(e.target.value)}
                          placeholder="名字"
                          className="w-20 bg-gray-50 rounded-lg px-2 py-1 text-xs font-bold"
                        />
                        <button
                          onClick={() => {
                            if (newMemberName) {
                              saveToFirebase("settings", {
                                members: [
                                  ...data.settings.members,
                                  newMemberName,
                                ],
                              });
                              setNewMemberName("");
                            }
                          }}
                          className="bg-gray-800 text-white px-3 rounded-lg text-xs font-bold"
                        >
                          +
                        </button>
                      </div>
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {(data.settings?.members || []).map((m) => (
                        <span
                          key={m}
                          className="bg-white border border-gray-100 px-3 py-1.5 rounded-full text-xs font-bold text-gray-600 flex items-center gap-2 shadow-sm"
                        >
                          {m}{" "}
                          <button
                            onClick={() => removeMember(m)}
                            className="text-gray-300 hover:text-red-400"
                          >
                            <Icon path={ICONS.x} size={12} />
                          </button>
                        </span>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 auto-rows-min">
                  {(data.expenses || []).map((ex) => {
                    const [m, d] = ex.date.split("/");
                    return (
                      <div
                        key={ex.id}
                        className={`bg-white rounded-2xl p-5 flex items-center gap-4 shadow-sm hover:shadow-lg transition-all border border-transparent ${
                          editingExpenseId === ex.id
                            ? "border-app-blue bg-blue-50/50"
                            : "hover:border-white/60"
                        }`}
                      >
                        <div className="bg-gray-50 rounded-2xl w-16 h-16 flex flex-col items-center justify-center flex-shrink-0 border border-gray-100">
                          <span className="text-[10px] text-gray-400 font-bold">
                            {m}月
                          </span>
                          <span className="text-2xl font-black text-gray-800 leading-none">
                            {d}
                          </span>
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-1">
                            <h4 className="font-bold text-gray-800 text-lg truncate">
                              {ex.item}
                            </h4>
                            <span className="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-md font-bold">
                              {ex.payer}
                            </span>
                          </div>
                          <div className="text-xl font-mono font-black text-gray-800 tracking-tight">
                            ¥{ex.total.toLocaleString()}
                          </div>
                          <div className="text-xs text-gray-400 font-bold mt-1">
                            每人 ¥{ex.perPerson.toLocaleString()} (
                            {ex.involved.length}人)
                          </div>
                        </div>
                        <div className="flex flex-col gap-2">
                          <button
                            onClick={() => {
                              setEditingExpenseId(ex.id);
                              setExpenseForm({
                                item: ex.item,
                                total: ex.total,
                                payer: ex.payer,
                                involved: ex.involved,
                              });
                            }}
                            className="p-2 bg-gray-50 hover:bg-app-blue hover:text-white rounded-xl text-gray-400 transition-colors"
                          >
                            <Icon path={ICONS.edit} size={16} />
                          </button>
                          <button
                            onClick={() =>
                              openConfirm("刪除?", () =>
                                saveToFirebase(
                                  "expenses",
                                  data.expenses.filter((e) => e.id !== ex.id)
                                )
                              )
                            }
                            className="p-2 bg-gray-50 hover:bg-red-500 hover:text-white rounded-xl text-gray-400 transition-colors"
                          >
                            <Icon path={ICONS.trash} size={16} />
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          );
        };

        const renderShoppingView = () => {
          const add = () => {
            if (newItem.name) {
              saveToFirebase("shopping", [
                ...data.shopping,
                { ...newItem, id: Date.now(), checked: false },
              ]);
              setNewItem({ name: "", qty: 1, note: "" });
            }
          };
          const toggle = (id) =>
            saveToFirebase(
              "shopping",
              data.shopping.map((i) =>
                i.id === id ? { ...i, checked: !i.checked } : i
              )
            );
          const del = (id) =>
            openConfirm("刪除？", () =>
              saveToFirebase(
                "shopping",
                data.shopping.filter((i) => i.id !== id)
              )
            );

          return (
            <div className="h-full px-6 md:px-10 pb-32 md:pb-10 overflow-y-auto custom-scrollbar">
              <div className="max-w-5xl mx-auto">
                <div className="glass-card rounded-3xl p-6 mb-8 sticky top-0 z-20">
                  <div className="flex flex-col md:flex-row gap-4">
                    <input
                      value={newItem.name}
                      onChange={(e) =>
                        setNewItem({ ...newItem, name: e.target.value })
                      }
                      placeholder="想買什麼？"
                      className="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm font-bold text-gray-700 mb-3 focus:bg-white transition-all"
                    />
                    <div className="flex gap-3">
                      <input
                        type="number"
                        value={newItem.qty}
                        onChange={(e) =>
                          setNewItem({ ...newItem, qty: e.target.value })
                        }
                        className="w-20 bg-gray-50 rounded-2xl px-2 py-4 text-center font-bold focus:bg-white"
                      />
                      <input
                        value={newItem.note}
                        onChange={(e) =>
                          setNewItem({ ...newItem, note: e.target.value })
                        }
                        placeholder="備註 (規格...)"
                        className="w-full md:w-48 bg-gray-50 rounded-2xl px-4 py-4 text-sm font-bold focus:bg-white"
                      />
                      <button
                        onClick={add}
                        className="bg-app-blue text-white w-12 h-10 rounded-xl flex items-center justify-center shadow-lg active:scale-95 transition-all"
                      >
                        <Icon path={ICONS.plus} size={24} />
                      </button>
                    </div>
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {(data.shopping || []).map((i) => (
                    <div
                      key={i.id}
                      onClick={() => toggle(i.id)}
                      className={`bg-white rounded-2xl p-4 flex items-center gap-4 shadow-sm transition-all cursor-pointer border border-transparent hover:border-white/50 ${
                        i.checked ? "opacity-60 grayscale bg-gray-50" : ""
                      }`}
                    >
                      <div
                        className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${
                          i.checked
                            ? "bg-app-blue border-app-blue text-white"
                            : "border-gray-200"
                        }`}
                      >
                        {i.checked && (
                          <Icon path={ICONS.check} size={14} strokeWidth="3" />
                        )}
                      </div>
                      <div className="flex-1">
                        <div
                          className={`font-bold text-gray-800 ${
                            i.checked ? "line-through" : ""
                          }`}
                        >
                          {i.name}
                        </div>
                        {i.note && (
                          <div className="text-xs text-gray-400 mt-0.5">
                            {i.note}
                          </div>
                        )}
                      </div>
                      <div className="bg-gray-100 text-gray-500 text-xs font-bold px-2 py-1 rounded-lg">
                        x{i.qty}
                      </div>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          del(i.id);
                        }}
                        className="text-gray-300 hover:text-red-400 p-2"
                      >
                        <Icon path={ICONS.trash} size={18} />
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          );
        };

        const renderSimpleListView = (type) => {
          const list = type === "info" ? data.info : data.mustBuy;

          const addRec = () => {
            if (!mustBuyForm.area || !mustBuyForm.item) return;
            const exists = data.mustBuy.find(
              (z) => z.area === mustBuyForm.area
            );
            const newList = exists
              ? data.mustBuy.map((z) =>
                  z.area === mustBuyForm.area
                    ? { ...z, items: [...z.items, mustBuyForm.item] }
                    : z
                )
              : [
                  ...data.mustBuy,
                  { area: mustBuyForm.area, items: [mustBuyForm.item] },
                ];
            saveToFirebase("mustBuy", newList);
            setMustBuyForm({ area: "", item: "" });
          };
          const delRec = (areaIdx, itemIdx) => {
            openConfirm("刪除?", () => {
              const newList = [...data.mustBuy];
              newList[areaIdx].items.splice(itemIdx, 1);
              saveToFirebase("mustBuy", newList);
            });
          };

          const addInfo = () => {
            if (!infoForm.title) return;
            saveToFirebase("info", [
              ...data.info,
              { ...infoForm, id: Date.now() },
            ]);
            setInfoForm({ title: "", link: "", note: "" });
          };
          const delInfo = (id) =>
            openConfirm("刪除?", () =>
              saveToFirebase(
                "info",
                data.info.filter((i) => i.id !== id)
              )
            );

          if (type === "recommend") {
            return (
              <div className="h-full px-6 md:px-10 pb-32 md:pb-10 overflow-y-auto custom-scrollbar">
                <div className="max-w-5xl mx-auto">
                  <div className="glass-card rounded-3xl p-6 mb-8 sticky top-0 z-20">
                    <div className="flex flex-col md:flex-row gap-3">
                      <input
                        value={mustBuyForm.area}
                        onChange={(e) =>
                          setMustBuyForm({
                            ...mustBuyForm,
                            area: e.target.value,
                          })
                        }
                        list="areas"
                        placeholder="區域 (如: 京都)"
                        className="w-full md:w-1/4 bg-gray-50 rounded-2xl px-4 py-3 text-sm font-bold focus:bg-white transition-all"
                      />
                      <datalist id="areas">
                        {data.mustBuy.map((z) => (
                          <option key={z.area} value={z.area} />
                        ))}
                      </datalist>
                      <input
                        value={mustBuyForm.item}
                        onChange={(e) =>
                          setMustBuyForm({
                            ...mustBuyForm,
                            item: e.target.value,
                          })
                        }
                        placeholder="推薦項目"
                        className="flex-1 bg-gray-50 rounded-2xl px-4 py-3 text-sm font-bold focus:bg-white transition-all"
                      />
                      <button
                        onClick={addRec}
                        className="bg-yellow-400 hover:bg-yellow-500 text-white font-bold px-6 py-3 rounded-2xl shadow-md active:scale-95 transition-all"
                      >
                        新增
                      </button>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {data.mustBuy.map((z, zIdx) => (
                      <div
                        key={z.area}
                        className="bg-white rounded-3xl overflow-hidden shadow-sm hover:shadow-lg transition-all"
                      >
                        <div className="bg-yellow-50 px-6 py-4 font-bold text-yellow-800 flex items-center gap-2">
                          <Icon path={ICONS.pin} size={18} /> {z.area}
                        </div>
                        <div className="p-3">
                          {z.items.map((it, iIdx) => (
                            <div
                              key={iIdx}
                              className="flex justify-between items-center p-3 hover:bg-gray-50 rounded-2xl group"
                            >
                              <span className="font-bold text-gray-700">
                                {it}
                              </span>
                              <button
                                onClick={() => delRec(zIdx, iIdx)}
                                className="text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"
                              >
                                <Icon path={ICONS.x} size={16} />
                              </button>
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="h-full px-6 md:px-10 pb-32 md:pb-10 overflow-y-auto custom-scrollbar">
              <div className="max-w-5xl mx-auto">
                <div className="glass-card rounded-3xl p-5 mb-6 sticky top-0 z-20">
                  <input
                    value={infoForm.title}
                    onChange={(e) =>
                      setInfoForm({ ...infoForm, title: e.target.value })
                    }
                    placeholder="標題"
                    className="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm font-bold mb-3 focus:bg-white"
                  />
                  <input
                    value={infoForm.link}
                    onChange={(e) =>
                      setInfoForm({ ...infoForm, link: e.target.value })
                    }
                    placeholder="連結 (選填)"
                    className="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm font-bold mb-3 focus:bg-white"
                  />
                  <button
                    onClick={addInfo}
                    className="w-full bg-gray-800 text-white font-bold py-3 rounded-xl shadow-md active:scale-95 transition-all"
                  >
                    新增資訊
                  </button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {data.info.map((i) => (
                    <div
                      key={i.id}
                      className="bg-white rounded-3xl p-6 shadow-sm hover:shadow-lg transition-all relative group flex flex-col justify-between min-h-[140px]"
                    >
                      <div>
                        <h3 className="font-bold text-xl text-gray-800 mb-2">
                          {i.title}
                        </h3>
                        {i.link && (
                          <a
                            href={i.link}
                            target="_blank"
                            className="text-xs font-bold text-blue-500 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors inline-flex items-center gap-1"
                          >
                            <Icon path={ICONS.globe} size={12} /> 開啟連結
                          </a>
                        )}
                        {i.note && (
                          <p className="text-sm text-gray-500 mt-3 whitespace-pre-line">
                            <LinkifiedText text={i.note} />
                          </p>
                        )}
                      </div>
                      <button
                        onClick={() => delInfo(i.id)}
                        className="absolute top-4 right-4 text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"
                      >
                        <Icon path={ICONS.trash} size={18} />
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          );
        };

        if (authLoading)
          return (
            <div className="h-screen w-full flex items-center justify-center bg-app-bg">
              <div className="animate-spin rounded-full h-8 w-8 border-4 border-app-blue border-t-transparent"></div>
            </div>
          );

        return (
          <div className="relative h-screen w-full bg-osaka-bg bg-cover bg-center overflow-hidden flex text-app-text">
            {/* Overlay */}
            <div className="absolute inset-0 bg-white/30 backdrop-blur-[2px] pointer-events-none"></div>

            <ConfirmModal
              isOpen={modalConfig.isOpen}
              message={modalConfig.message}
              onConfirm={modalConfig.onConfirm}
              onCancel={modalConfig.onCancel}
            />

            {/* Desktop Sidebar */}
            {renderNav()}

            {/* Main Content Area */}
            <div className="relative z-10 flex-1 flex flex-col h-full min-w-0 overflow-hidden">
              {renderHeader()}

              <main className="flex-1 overflow-hidden relative">
                {activeTab === "itinerary" && renderItineraryView()}
                {activeTab === "shopping" && renderShoppingView()}
                {activeTab === "tools" && renderExpensesView()}
                {(activeTab === "recommend" || activeTab === "info") &&
                  renderSimpleListView(activeTab)}
              </main>

              {/* Mobile Floating Nav */}
              {renderFloatingNav()}
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
